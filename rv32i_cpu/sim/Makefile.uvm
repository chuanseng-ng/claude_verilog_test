#-----------------------------------------------------------------------------
# UVM Testbench Makefile for RV32I CPU
# Supports: VCS, Questa/ModelSim, Xcelium
#-----------------------------------------------------------------------------

# Default simulator (vcs, questa, xcelium)
SIM ?= questa

# UVM version
UVM_VERSION ?= 1.2

# Test to run (default: rv32i_random_test)
TEST ?= rv32i_random_test

# Seed for randomization
SEED ?= random

# Verbosity (UVM_NONE, UVM_LOW, UVM_MEDIUM, UVM_HIGH, UVM_FULL, UVM_DEBUG)
VERBOSITY ?= UVM_MEDIUM

# Enable waves
WAVES ?= 0

# GUI mode
GUI ?= 0

#-----------------------------------------------------------------------------
# Directory Structure
#-----------------------------------------------------------------------------
PROJ_ROOT    = ..
RTL_DIR      = $(PROJ_ROOT)/rtl
TB_DIR       = $(PROJ_ROOT)/tb
UVM_TB_DIR   = $(TB_DIR)/uvm
SIM_DIR      = .
WORK_DIR     = work_uvm
LOG_DIR      = logs

#-----------------------------------------------------------------------------
# Source Files - RTL
#-----------------------------------------------------------------------------
PKG_FILES = \
	$(RTL_DIR)/pkg/rv32i_pkg.sv \
	$(RTL_DIR)/pkg/axi4lite_pkg.sv

CORE_FILES = \
	$(RTL_DIR)/core/rv32i_alu.sv \
	$(RTL_DIR)/core/rv32i_regfile.sv \
	$(RTL_DIR)/core/rv32i_imm_gen.sv \
	$(RTL_DIR)/core/rv32i_decode.sv \
	$(RTL_DIR)/core/rv32i_control.sv \
	$(RTL_DIR)/core/rv32i_core.sv

INTERFACE_FILES = \
	$(RTL_DIR)/interfaces/axi4lite_master.sv \
	$(RTL_DIR)/interfaces/apb3_slave.sv

DEBUG_FILES = \
	$(RTL_DIR)/debug/rv32i_debug.sv

TOP_FILE = $(RTL_DIR)/rv32i_cpu_top.sv

RTL_FILES = $(PKG_FILES) $(CORE_FILES) $(INTERFACE_FILES) $(DEBUG_FILES) $(TOP_FILE)

#-----------------------------------------------------------------------------
# Source Files - UVM Testbench
#-----------------------------------------------------------------------------
UVM_PKG_FILES = \
	$(UVM_TB_DIR)/rv32i_uvm_pkg.sv

UVM_IF_FILES = \
	$(UVM_TB_DIR)/agents/axi4lite/axi4lite_if.sv \
	$(UVM_TB_DIR)/agents/apb3/apb3_if.sv

UVM_AGENT_PKG_FILES = \
	$(UVM_TB_DIR)/agents/axi4lite/axi4lite_agent_pkg.sv \
	$(UVM_TB_DIR)/agents/apb3/apb3_agent_pkg.sv

UVM_ENV_PKG_FILE = $(UVM_TB_DIR)/env/rv32i_env_pkg.sv

UVM_TEST_PKG_FILE = $(UVM_TB_DIR)/tests/rv32i_test_pkg.sv

UVM_TOP_FILE = $(UVM_TB_DIR)/top/tb_uvm_top.sv

UVM_FILES = $(UVM_PKG_FILES) $(UVM_IF_FILES) $(UVM_AGENT_PKG_FILES) $(UVM_ENV_PKG_FILE) $(UVM_TEST_PKG_FILE) $(UVM_TOP_FILE)

#-----------------------------------------------------------------------------
# Include Paths
#-----------------------------------------------------------------------------
INCDIR = \
	+incdir+$(RTL_DIR)/pkg \
	+incdir+$(RTL_DIR)/core \
	+incdir+$(RTL_DIR)/interfaces \
	+incdir+$(RTL_DIR)/debug \
	+incdir+$(RTL_DIR) \
	+incdir+$(UVM_TB_DIR) \
	+incdir+$(UVM_TB_DIR)/agents/axi4lite \
	+incdir+$(UVM_TB_DIR)/agents/apb3 \
	+incdir+$(UVM_TB_DIR)/env \
	+incdir+$(UVM_TB_DIR)/sequences \
	+incdir+$(UVM_TB_DIR)/tests \
	+incdir+$(UVM_TB_DIR)/top

#-----------------------------------------------------------------------------
# VCS Options
#-----------------------------------------------------------------------------
VCS = vcs
VCS_OPTS = -full64 -sverilog -ntb_opts uvm-$(UVM_VERSION) \
	-timescale=1ns/1ps \
	+vcs+lic+wait \
	-debug_access+all \
	$(INCDIR) \
	+define+ENABLE_ASSERTIONS

VCS_RUN_OPTS = +UVM_TESTNAME=$(TEST) \
	+UVM_VERBOSITY=$(VERBOSITY)

ifeq ($(SEED),random)
	VCS_RUN_OPTS += +ntb_random_seed_automatic
else
	VCS_RUN_OPTS += +ntb_random_seed=$(SEED)
endif

ifeq ($(WAVES),1)
	VCS_OPTS += +define+WAVES
	VCS_RUN_OPTS += +waves
endif

#-----------------------------------------------------------------------------
# Questa/ModelSim Options
#-----------------------------------------------------------------------------
VLIB = vlib
VMAP = vmap
VLOG = vlog
VSIM = vsim

QUESTA_VLOG_OPTS = -sv -work $(WORK_DIR) \
	+incdir+$(UVM_HOME)/src \
	$(INCDIR) \
	+define+ENABLE_ASSERTIONS \
	-suppress 2286

QUESTA_VSIM_OPTS = -work $(WORK_DIR) \
	-L $(WORK_DIR) \
	-sv_seed $(SEED) \
	+UVM_TESTNAME=$(TEST) \
	+UVM_VERBOSITY=$(VERBOSITY) \
	-voptargs=+acc \
	-suppress 3829

ifeq ($(GUI),1)
	QUESTA_VSIM_OPTS +=
else
	QUESTA_VSIM_OPTS += -c -do "run -all; exit"
endif

ifeq ($(WAVES),1)
	QUESTA_VSIM_OPTS += +waves -do "log -r /*"
endif

#-----------------------------------------------------------------------------
# Xcelium Options
#-----------------------------------------------------------------------------
XRUN = xrun
XRUN_OPTS = -64bit -sv -uvm \
	-timescale 1ns/1ps \
	-access +rwc \
	$(INCDIR) \
	+define+ENABLE_ASSERTIONS \
	+UVM_TESTNAME=$(TEST) \
	+UVM_VERBOSITY=$(VERBOSITY)

ifeq ($(SEED),random)
	XRUN_OPTS += -svseed random
else
	XRUN_OPTS += -svseed $(SEED)
endif

ifeq ($(WAVES),1)
	XRUN_OPTS += +waves -input "database -open waves.shm -default; probe -all -depth all"
endif

ifeq ($(GUI),1)
	XRUN_OPTS += -gui
endif

#-----------------------------------------------------------------------------
# Targets
#-----------------------------------------------------------------------------
.PHONY: all compile sim run clean help vcs questa xcelium list_tests

all: sim

# Create directories
$(WORK_DIR):
	mkdir -p $(WORK_DIR)

$(LOG_DIR):
	mkdir -p $(LOG_DIR)

#-----------------------------------------------------------------------------
# VCS Flow
#-----------------------------------------------------------------------------
vcs_compile: $(LOG_DIR)
	$(VCS) $(VCS_OPTS) \
		$(RTL_FILES) $(UVM_FILES) \
		-top tb_uvm_top \
		-o simv \
		-l $(LOG_DIR)/vcs_compile.log

vcs_run: vcs_compile
	./simv $(VCS_RUN_OPTS) -l $(LOG_DIR)/vcs_run_$(TEST).log

vcs: vcs_run

#-----------------------------------------------------------------------------
# Questa/ModelSim Flow
#-----------------------------------------------------------------------------
questa_lib: $(WORK_DIR)
	$(VLIB) $(WORK_DIR)

questa_compile: questa_lib $(LOG_DIR)
	$(VLOG) $(QUESTA_VLOG_OPTS) \
		$(RTL_FILES) $(UVM_FILES) \
		-l $(LOG_DIR)/questa_compile.log

questa_run: questa_compile
	$(VSIM) $(QUESTA_VSIM_OPTS) \
		tb_uvm_top \
		-l $(LOG_DIR)/questa_run_$(TEST).log

questa: questa_run

#-----------------------------------------------------------------------------
# Xcelium Flow
#-----------------------------------------------------------------------------
xcelium: $(LOG_DIR)
	$(XRUN) $(XRUN_OPTS) \
		$(RTL_FILES) $(UVM_FILES) \
		-top tb_uvm_top \
		-l $(LOG_DIR)/xcelium_run_$(TEST).log

#-----------------------------------------------------------------------------
# Generic targets (use SIM variable)
#-----------------------------------------------------------------------------
compile:
ifeq ($(SIM),vcs)
	$(MAKE) vcs_compile
else ifeq ($(SIM),questa)
	$(MAKE) questa_compile
else ifeq ($(SIM),xcelium)
	@echo "Xcelium compiles during run"
else
	@echo "Unknown simulator: $(SIM)"
	@exit 1
endif

sim:
ifeq ($(SIM),vcs)
	$(MAKE) vcs
else ifeq ($(SIM),questa)
	$(MAKE) questa
else ifeq ($(SIM),xcelium)
	$(MAKE) xcelium
else
	@echo "Unknown simulator: $(SIM)"
	@exit 1
endif

run: sim

#-----------------------------------------------------------------------------
# Run Different Tests
#-----------------------------------------------------------------------------
test_random:
	$(MAKE) sim TEST=rv32i_random_test

test_alu:
	$(MAKE) sim TEST=rv32i_alu_test

test_loadstore:
	$(MAKE) sim TEST=rv32i_loadstore_test

test_branch:
	$(MAKE) sim TEST=rv32i_branch_test

test_debug:
	$(MAKE) sim TEST=rv32i_debug_test

test_latency:
	$(MAKE) sim TEST=rv32i_latency_test

test_comprehensive:
	$(MAKE) sim TEST=rv32i_comprehensive_test

# Run all tests
test_all: test_random test_alu test_loadstore test_branch test_debug test_latency

#-----------------------------------------------------------------------------
# Regression
#-----------------------------------------------------------------------------
REGRESSION_TESTS = rv32i_random_test rv32i_alu_test rv32i_loadstore_test \
                   rv32i_branch_test rv32i_debug_test rv32i_latency_test

regression: $(LOG_DIR)
	@echo "Running regression..."
	@for test in $(REGRESSION_TESTS); do \
		echo "Running $$test..."; \
		$(MAKE) sim TEST=$$test SEED=random; \
	done
	@echo "Regression complete."

#-----------------------------------------------------------------------------
# Clean
#-----------------------------------------------------------------------------
clean:
	rm -rf $(WORK_DIR)
	rm -rf $(LOG_DIR)
	rm -rf simv simv.daidir csrc
	rm -rf xcelium.d
	rm -rf *.shm
	rm -rf transcript
	rm -rf *.vcd *.vpd *.fsdb
	rm -rf .simvision
	rm -rf DVEfiles
	rm -f *.log

#-----------------------------------------------------------------------------
# Help
#-----------------------------------------------------------------------------
help:
	@echo "=========================================="
	@echo "RV32I UVM Testbench Makefile"
	@echo "=========================================="
	@echo ""
	@echo "Usage: make [target] [options]"
	@echo ""
	@echo "Targets:"
	@echo "  sim              - Compile and run simulation (default)"
	@echo "  compile          - Compile only"
	@echo "  vcs              - Run with VCS"
	@echo "  questa           - Run with Questa/ModelSim"
	@echo "  xcelium          - Run with Xcelium"
	@echo ""
	@echo "  test_random      - Run random program test"
	@echo "  test_alu         - Run ALU test"
	@echo "  test_loadstore   - Run load/store test"
	@echo "  test_branch      - Run branch test"
	@echo "  test_debug       - Run debug interface test"
	@echo "  test_latency     - Run latency stress test"
	@echo "  test_comprehensive - Run comprehensive test"
	@echo "  test_all         - Run all individual tests"
	@echo "  regression       - Run full regression"
	@echo ""
	@echo "  clean            - Remove build artifacts"
	@echo "  help             - Show this help"
	@echo ""
	@echo "Options:"
	@echo "  SIM=<vcs|questa|xcelium>  Simulator (default: questa)"
	@echo "  TEST=<test_name>          Test to run (default: rv32i_random_test)"
	@echo "  SEED=<number|random>      Random seed (default: random)"
	@echo "  VERBOSITY=<level>         UVM verbosity (default: UVM_MEDIUM)"
	@echo "  WAVES=<0|1>               Enable waveform dump (default: 0)"
	@echo "  GUI=<0|1>                 Run in GUI mode (default: 0)"
	@echo ""
	@echo "Examples:"
	@echo "  make sim                              # Run default test with Questa"
	@echo "  make vcs TEST=rv32i_alu_test          # Run ALU test with VCS"
	@echo "  make questa WAVES=1 GUI=1             # Run with waves in GUI"
	@echo "  make regression SIM=xcelium           # Run regression with Xcelium"
	@echo ""

list_tests:
	@echo "Available Tests:"
	@echo "  rv32i_base_test         - Base test (no sequence)"
	@echo "  rv32i_random_test       - Random program generation"
	@echo "  rv32i_alu_test          - ALU operations focus"
	@echo "  rv32i_loadstore_test    - Load/Store operations"
	@echo "  rv32i_branch_test       - Branch operations"
	@echo "  rv32i_debug_test        - Debug interface"
	@echo "  rv32i_latency_test      - Memory latency stress"
	@echo "  rv32i_comprehensive_test - All tests combined"
